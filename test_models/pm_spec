data {
  int N_national_polls
  int N_state_polls
  int T
  int S
  int P
  int M
  int Pop
  int_array[N_state_polls] state
  int_array[N_state_polls] day_state
  int_array[N_national_polls] day_national
  int_array[N_state_polls] poll_state
  int_array[N_national_polls] poll_national
  int_array[N_state_polls] poll_mode_state
  int_array[N_national_polls] poll_mode_national
  int_array[N_state_polls] poll_pop_state
  int_array[N_national_polls] poll_pop_national
  int_array[N_national_polls] n_democrat_national
  int_array[N_national_polls] n_two_share_national
  int_array[N_state_polls] n_democrat_state
  int_array[N_state_polls] n_two_share_state

  int N_pot
  int_array[N_pot] state_pot
  int_array[N_pot] day_pot
  int_array[N_pot] poll_pot
  int_array[N_pot] poll_mode_pot
  int_array[N_pot] poll_pop_pot
  int_array[N_pot] unadjusted_pot
  int_array[N_pot] n_two_share_pot
  int S_star
  int T_star
}

parameters {
  array[S, T] mu_b
  array[P] mu_c
  array[M] mu_m
  array[Pop] mu_pop
  array[T] e_bias
  array[S] polling_bias
  array[N_state_polls] raw_measure_noise_state
  array[N_national_polls] raw_measure_noise_national
  array[T] national_mu_b_average
  real national_polling_bias_average
  real mu_e_bias
  real rho_e_bias

  array[N_pot] n_democrat_potential
  array[N_pot] raw_measure_noise_pot
}

model {
  mu_b[1:S, T] ~ normal(0)
  for(t in 1:sub(T,1)) {
    mu_b[1:S, t] ~ normal(mu_b[1:S, add(t,1)])
  }
  for(p in 1:P) {
    mu_c[p] ~ normal(0)
  }
  for(m in 1:M) {
    mu_m[m] ~ normal(0)
  }
  for(p in 1:Pop) {
    mu_pop[p] ~ normal(0)
  }
  e_bias[1] ~ normal(mu_e_bias)
  for(t in 2:T) {
    e_bias[t] ~ normal(e_bias[sub(t,1)], mu_e_bias, rho_e_bias)
  }
  polling_bias[1:S] ~ normal(0)
  for(i in 1:N_state_polls) {
    raw_measure_noise_state[i] ~ normal(0)
    n_democrat_state[i] ~ normal(mu_b[state[i], day_state[i]], mu_c[poll_state[i]], mu_m[poll_mode_state[i]], mu_pop[poll_pop_state[i]], e_bias[day_state[i]], raw_measure_noise_state[i], polling_bias[state[i]])
  }
  for(i in 1:N_national_polls) {
    raw_measure_noise_national ~ normal(0)
    n_democrat_national[i] ~ normal(mu_b[1:S, day_national[i]], mu_c[poll_national[i]], mu_m[poll_mode_national[i]], mu_pop[poll_pop_national[i]], e_bias[day_national[i]], raw_measure_noise_national[i], polling_bias[1:S])
  }
  for(i in 1:N_pot) {
    raw_measure_noise_pot[i] ~ normal(0)
    n_democrat_potential[i] ~ normal(mu_b[state_pot[i], day_pot[i]], mu_c[poll_pot[i]], mu_m[poll_mode_pot[i]], mu_pop[poll_pop_pot[i]], e_bias[day_pot[i]], raw_measure_noise_pot[i], polling_bias[state_pot[i]])
  }
}

tree {
  root(mu_b[S_star, T_star])
  leaf(n_democrat_potential[1:N_pot])
}