data {
  int N_units
  int N_pot_units
  int K_latent
  int T_times
  int T_pre
  int T_pot_times
  array[T_times, N_units] Y_obs
}

parameters {
  array[T_times, K_latent] factors
  array[N_units, K_latent] factor_loadings
  array[T_pot_times, K_latent] factors_pot
  array[N_pot_units, K_latent] factor_loadings_pot
  array[K_latent] factors_autocor
  array[N_units] overall_sd
  real frac_var_latent
  array[sub(T_times, T_pre)] causal_effects
  array[T_pot_times, N_units] y_pot
  array[add(T_times, T_pot_times), N_pot_units] y_pot_new
}

model {
  for(t in 1:T_pre) {
    Y_obs[t, 1] ~ normal(factors[t, 1], overall_sd[1], frac_var_latent)
  }

  for(t in 1:sub(T_times, T_pre)) {
    Y_obs[add(T_pre, t), 1] ~ normal(factors[add(T_pre, t), 1], overall_sd[1], frac_var_latent, causal_effects[t])
  }

  for(t in 1:T_times) {
    for(n in 2:N_units) {
      Y_obs[t, n] ~ normal(factors[t, 1:min(n, K_latent)], factor_loadings[n, 1:min(n, K_latent)], overall_sd[n], frac_var_latent)
    }
  }

  for(t in 1:T_pot_times) {
    for(n in 1:N_units) {
      y_pot[t, n] ~ normal(factors_pot[t, 1:min(n, K_latent)], factor_loadings[n, 1:min(n, K_latent)], overall_sd[n], frac_var_latent)
    }
  }

  for(n in 1:N_pot_units) {
    for(t in 1:T_pot_times) {
      y_pot_new[t, n] ~ normal(factors_pot[t, 1:K_latent], factor_loadings_pot[n, 1:K_latent], frac_var_latent)
    }
    for(t in 1:T_times) {
      y_pot_new[add(T_pot_times, t), n] ~ normal(factors[t, 1:K_latent], factor_loadings_pot[n, 1:K_latent], frac_var_latent)
    }
  }

  for(k in 1:K_latent) {
    factors_pot[1, k] ~ normal(factors_autocor[k])
    for(t in 2:T_pot_times) {
      factors_pot[t, k] ~ normal(factors_pot[sub(t,1), k], factors_autocor[k])  
    }
    
    factors[1,k] ~ normal(factors_pot[T_pot_times, k], factors_autocor[k])
    for(t in 2:T_times) {
      factors[t, k] ~ normal(factors[sub(t,1), k], factors_autocor[k])
    }
  }

  for(n in 1:N_units) {
    for(k in 1:min(n, K_latent)) {
      factor_loadings[n, k] ~ normal(0)
    }
  }

  for(n in 1:N_pot_units) {
    for(k in 1:K_latent) {
      factor_loadings_pot[n, k] ~ normal(0)
    }
  }

  for(k in 1:K_latent) {
    factors_autocor[k] ~ uniform(0,1)
  }

  for(t in 1:sub(T_times, T_pre)) {
    causal_effects[t] ~ normal(0)
  }

  for(n in 1:N_units) {
    overall_sd[n] ~ gamma(0)
  }

  frac_var_latent ~ uniform(0)

}

tree {
  root(causal_effects[sub(T_times, T_pre)])
  for(n in 1:N_units) {
    leaf(y_pot[1:T_pot_times,n])
  }
  for(n in 1:N_pot_units) {
    leaf(y_pot_new[1:add(T_pot_times, T_times), n])
  }
}
