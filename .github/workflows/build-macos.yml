name: Build macOS

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build (macOS ARM64)
    runs-on: macos-15
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install C++ libraries
        run: |
          brew install boost openssl@3 zlib nlohmann-json
          curl -sL https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz | tar xz -C /tmp
          cmake -S /tmp/eigen-3.4.0 -B /tmp/eigen-build -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_TESTING=OFF
          sudo cmake --install /tmp/eigen-build
          git clone --depth 1 https://gitlab.com/eidheim/Simple-WebSocket-Server.git /tmp/simple-ws
          sudo mkdir -p /usr/local/include/simple-websocket-server
          sudo cp /tmp/simple-ws/*.hpp /usr/local/include/simple-websocket-server/

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5
          dune-cache: true
          opam-local-packages: fg_parser/*.opam

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build
        run: |
          export CMAKE_PREFIX_PATH="$(brew --prefix openssl@3):$(brew --prefix boost):$(brew --prefix zlib)"
          eval $(opam env)
          ./build.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: variance-deltas-macos-arm64
          path: build/
          retention-days: 3

      - name: Create release tarball
        if: startsWith(github.ref, 'refs/tags/')
        run: tar -czf variance-deltas-macos-arm64.tar.gz -C build .

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            variance-deltas-macos-arm64.tar.gz \
            --title "Release ${{ github.ref_name }}" \
            --prerelease
